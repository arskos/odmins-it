var request; //Actual Postvar conf = {};var q; // Input TextjQuery.fn.sugerir = function(opciones) {        conf = $.extend( {      'limite' : 5,      'filtro' : 3,       'ajaxSuggestUrl' : '',      'max': 6,      'min': 2,    }, opciones);	    renderizarEtiquetasActuales();        $('#searcher_tags').on('click', function(e){        $('.tag_selectable input').focus();    });        this.on('keyup', function(){        q = $(this);        tagSendRequest($(this));    });        this.on('focusin', function(){        tagSendRequest($(this));    });    var x = this;    $(document).on('click', function(e){        if ($(e.target).closest('.tag_suggest').length) tagSendRequest(x);        else $('.tag_suggest').empty();    });    };jQuery.fn.etiquetar = function() {	    this.on('click', function(){        procesarSeleccion($(this));    });    };jQuery.fn.teclear = function() {	    this.on('keypress', function(e){        procesarTecla($(this), e);    });    };jQuery.fn.tagdelete = function() {	    this.on('click', function(e){        e.preventDefault();        $(this).parent().remove();        q.removeAttr('readonly');    });    return this;};function procesarTecla(campo, evento){    var charCode = evento.charCode || evento.keyCode;    if (charCode == 13) //Enter    {        evento.preventDefault();        if (campo.val().length > 0)        {            addTagFromText(campo.val());        }    }     else if (charCode == 8) //backspace    {        procesarBackspace(campo.val());    }        else if (charCode == 9) //Tab    {            evento.preventDefault();        if (campo.val().length > 0)        {            addTagFromText(campo.val());        }            }    else if (charCode == 32) //Space    {        evento.preventDefault();        if (campo.val().length > 0)        {            addTagFromText(campo.val());        }    }}function procesarBackspace(texto){    if (texto.length == 0)    {        $(".tag_selection span:last-child").remove();        q.removeAttr('readonly');    }}function tagSendRequest(campo){    if (campo.val().length >= conf.filtro)    {        if (request != null) request.abort();                request = $.ajax({          url: conf.ajaxSuggestUrl,          type: "POST",          cache: false,          data: {consulta: campo.val()}        }).done(function(data) {            $('.tag_suggest').empty().html(data);            $('.opcion').etiquetar();        });    }}function procesarSeleccion(opcion){    var texto = prepararTexto(opcion.text());    var existe = $(".tag_selection").find('input[alt="' + texto + '"]').length;    var etiquetas = $(".tag_selection input").length;        if (existe == 0)    {        if (texto.length <= conf.max && conf.min <= texto.length)        {            var label = $('<span>').attr({id: 'opcion' + opcion.attr('id') }).text(texto);            var accion = $('<a>').text(" ").attr({href: '#'}).tagdelete();            var check = $('<input>').attr({name: 'tags[]', value: opcion.attr('id'), type: "hidden", alt: texto});            label.append(check);            label.append(accion);            $('.tag_selection').append(label);            $('.tag_suggest').empty();            $('#consulta').val('');                        if (etiquetas >= conf.limite)             {                q.attr('readonly', 'readonly');            }        }    }}function addTagFromText(texto){    texto = prepararTexto(texto);    var existe = $(".tag_selection").find('input[alt="' + texto + '"]').length;    var etiquetas = $(".tag_selection input").length;        if (existe == 0)    {        if (texto.length <= conf.max && conf.min <= texto.length)        {            var label = $('<span>').attr({name: texto, "class": "tag_new" }).text(texto);            var accion = $('<a>').text(" ").attr({href: '#'}).tagdelete();            var check = $('<input>').attr({name: 'tags_news[]', value: texto, type: "hidden", alt: texto });                        label.append(check);            label.append(accion);            $('.tag_selection').append(label);            $('.tag_suggest').empty();            $('#consulta').val('');                        if (etiquetas >= conf.limite)             {                q.attr('readonly', 'readonly');            }        }    }}function prepararTexto(texto){    texto = texto.toLowerCase();    texto = jQuery.trim(texto);    return texto;}function renderizarEtiquetasActuales(){    var datos = $('.tag_selectable input').val();    var etiquetas = datos.split(" ");    for (var i = 0; i < etiquetas.length; i ++)    {        if (etiquetas[i].length)            addTagFromText(etiquetas[i]);    }}